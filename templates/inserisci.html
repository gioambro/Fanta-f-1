<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Inserisci risultati della giornata</title>
  <style>
    fieldset { margin-bottom: 18px; padding: 12px; }
    legend { font-weight: bold; color: #b30000; }
    .pilot-box { border:1px solid #bbb; padding:10px; margin-bottom:8px; }
    label { display:block; margin-top:6px; }
    .inline { display:inline-block; margin-right:12px; }
  </style>
</head>
<body>
  <h1>Inserisci risultati della giornata</h1>

  <form action="{{ url_for('salva') }}" method="post">
    {% for player in players %}
      {% set i = loop.index0 %}
      <fieldset>
        <legend>{{ player }}</legend>

        <!-- PILOTA 1 -->
        <div class="pilot-box">
          <h3>Pilota 1</h3>
          <label>Nome pilota 1:
            <input type="text" name="p{{i}}_pilot1_name" value="Pilota1">
          </label>

          <label class="inline">Griglia di partenza:
            <input type="number" min="1" max="20" name="p{{i}}_pilot1_griglia" value="">
          </label>

          <label class="inline">Posizione finale:
            <input type="number" min="0" max="20" name="p{{i}}_pilot1_posizione" value="">
          </label>

          <label>Gara sprint?
            <select name="p{{i}}_pilot1_sprint" id="sprint_{{i}}_1" onchange="toggleSprint({{i}},1)">
              <option value="no">No</option>
              <option value="si">Sì</option>
            </select>
          </label>

          <div id="sprint_pos_div_{{i}}_1" style="display:none;">
            <label>Posizione Sprint:
              <select name="p{{i}}_pilot1_sprint_pos">
                <option value="">--</option>
                <option value="1">1 (8 pt)</option>
                <option value="2">2 (7 pt)</option>
                <option value="3">3 (6 pt)</option>
                <option value="4">4 (5 pt)</option>
                <option value="5">5 (4 pt)</option>
                <option value="6">6 (3 pt)</option>
                <option value="7">7 (2 pt)</option>
                <option value="8">8 (1 pt)</option>
              </select>
            </label>
          </div>

          <hr>
          <!-- BONUS (sì/no) -->
          <label class="inline">Pole (+2):
            <select name="p{{i}}_pilot1_pole">
              <option value="no">No</option><option value="si">Sì</option>
            </select>
          </label>

          <label class="inline">Giro veloce (+1):
            <select name="p{{i}}_pilot1_fastest_lap" class="unique fastest_lap">
              <option value="no">No</option><option value="si">Sì</option>
            </select>
          </label>

          <label class="inline">Driver of the Day (+1):
            <select name="p{{i}}_pilot1_driver_day" class="unique driver_day">
              <option value="no">No</option><option value="si">Sì</option>
            </select>
          </label>

          <label class="inline">Fastest pit-stop (+2):
            <select name="p{{i}}_pilot1_fastest_pit" class="unique fastest_pit">
              <option value="no">No</option><option value="si">Sì</option>
            </select>
          </label>

          <label class="inline">Parte dalle ultime 2 file ma va a punti (+2):
            <select name="p{{i}}_pilot1_rimonta">
              <option value="no">No</option><option value="si">Sì</option>
            </select>
          </label>

          <label class="inline">Altri bonus (es. giro veloce manuale, se serve):</label>

          <hr>
          <!-- MALUS -->
          <label class="inline">Squalifica (-5):
            <select name="p{{i}}_pilot1_squalifica">
              <option value="no">No</option><option value="si">Sì</option>
            </select>
          </label>

          <label class="inline">DNF (-3):
            <select name="p{{i}}_pilot1_dnf">
              <option value="no">No</option><option value="si">Sì</option>
            </select>
          </label>

          <label class="inline">Penalità ≥6s (-4):
            <select name="p{{i}}_pilot1_pen6"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Penalità ≤5s (-3):
            <select name="p{{i}}_pilot1_pen5"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Ultimo in gara (-2):
            <select name="p{{i}}_pilot1_last_place" class="unique last_place"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Non supera Q1 (-1):
            <select name="p{{i}}_pilot1_q1"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

        </div>

        <!-- PILOTA 2 (stesso schema) -->
        <div class="pilot-box">
          <h3>Pilota 2</h3>
          <label>Nome pilota 2:
            <input type="text" name="p{{i}}_pilot2_name" value="Pilota2">
          </label>

          <label class="inline">Griglia di partenza:
            <input type="number" min="1" max="20" name="p{{i}}_pilot2_griglia" value="">
          </label>

          <label class="inline">Posizione finale:
            <input type="number" min="0" max="20" name="p{{i}}_pilot2_posizione" value="">
          </label>

          <label>Gara sprint?
            <select name="p{{i}}_pilot2_sprint" id="sprint_{{i}}_2" onchange="toggleSprint({{i}},2)">
              <option value="no">No</option>
              <option value="si">Sì</option>
            </select>
          </label>

          <div id="sprint_pos_div_{{i}}_2" style="display:none;">
            <label>Posizione Sprint:
              <select name="p{{i}}_pilot2_sprint_pos">
                <option value="">--</option>
                <option value="1">1 (8 pt)</option>
                <option value="2">2 (7 pt)</option>
                <option value="3">3 (6 pt)</option>
                <option value="4">4 (5 pt)</option>
                <option value="5">5 (4 pt)</option>
                <option value="6">6 (3 pt)</option>
                <option value="7">7 (2 pt)</option>
                <option value="8">8 (1 pt)</option>
              </select>
            </label>
          </div>

          <hr>
          <label class="inline">Pole (+2):
            <select name="p{{i}}_pilot2_pole"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Giro veloce (+1):
            <select name="p{{i}}_pilot2_fastest_lap" class="unique fastest_lap"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Driver of the Day (+1):
            <select name="p{{i}}_pilot2_driver_day" class="unique driver_day"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Fastest pit-stop (+2):
            <select name="p{{i}}_pilot2_fastest_pit" class="unique fastest_pit"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Parte dalle ultime 2 file ma va a punti (+2):
            <select name="p{{i}}_pilot2_rimonta"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <hr>
          <label class="inline">Squalifica (-5):
            <select name="p{{i}}_pilot2_squalifica"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">DNF (-3):
            <select name="p{{i}}_pilot2_dnf"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Penalità ≥6s (-4):
            <select name="p{{i}}_pilot2_pen6"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Penalità ≤5s (-3):
            <select name="p{{i}}_pilot2_pen5"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Ultimo in gara (-2):
            <select name="p{{i}}_pilot2_last_place" class="unique last_place"><option value="no">No</option><option value="si">Sì</option></select>
          </label>

          <label class="inline">Non supera Q1 (-1):
            <select name="p{{i}}_pilot2_q1"><option value="no">No</option><option value="si">Sì</option></select>
          </label>
        </div>

      </fieldset>
    {% endfor %}

    <button type="submit">Salva risultati</button>
  </form>

<script>
  function toggleSprint(i, p) {
    const sel = document.getElementById(`sprint_${i}_${p}`);
    const div = document.getElementById(`sprint_pos_div_${i}_${p}`);
    if (!sel || !div) return;
    div.style.display = (sel.value === 'si') ? 'block' : 'none';
  }

  // rende unici i bonus contrassegnati dalla classe "unique" (es. driver_day, fastest_lap, fastest_pit, last_place)
  document.addEventListener('DOMContentLoaded', () => {
    const uniques = document.querySelectorAll('select.unique');
    uniques.forEach(sel => {
      sel.addEventListener('change', function() {
        if (this.value === 'si') {
          // disattiva tutti gli altri con la stessa classe (stessa categoria)
          const classes = ['driver_day','fastest_lap','fastest_pit','last_place'];
          // trova quale classe contiene questo elemento
          let myClass = classes.find(c => this.classList.contains(c));
          if (!myClass) return;
          const others = document.querySelectorAll('select.' + myClass);
          others.forEach(o => {
            if (o !== this) {
              o.value = 'no';
            }
          });
        }
      });
    });
  });
</script>

</body>
</html>
