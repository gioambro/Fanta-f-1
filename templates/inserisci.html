<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Inserisci risultati giornata</title>
  <style>
    fieldset { padding:10px; margin-bottom:10px; }
    label { display:block; margin:4px 0; }
    .mini { font-size: 0.9em; color:#444; }
  </style>
</head>
<body>
  <h1>Inserisci risultati giornata</h1>

  <form action="{{ url_for('inserisci') }}" method="POST" id="formGiornata">
    {% for i in range(1,7) %}
    <fieldset>
      <legend>Giocatore {{ i }}</legend>

      {% for p in range(1,3) %}
      <h4>Pilota {{ p }}</h4>
      <label>Posizione finale:
        <input type="number" min="1" max="30"
               name="g{{i}}_p{{p}}_pos" id="g{{i}}_p{{p}}_pos">
      </label>

      <label>Griglia di partenza:
        <input type="number" min="1" max="30"
               name="g{{i}}_p{{p}}_griglia" id="g{{i}}_p{{p}}_griglia">
      </label>

      <label class="mini"><input type="checkbox" name="g{{i}}_p{{p}}_sprint" id="g{{i}}_p{{p}}_sprint"> Gara Sprint (se spuntata vittoria/podio non vengono auto applicati)</label>

      <!-- BONUS -->
      <label><input type="checkbox" name="g{{i}}_p{{p}}_pole" id="g{{i}}_p{{p}}_pole"> Pole Position (+2)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_fastest_lap" id="g{{i}}_p{{p}}_fastest_lap"> Giro veloce (+1)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_driver_day" id="g{{i}}_p{{p}}_driver_day"> Driver of the Day (+1)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_fastest_pit" id="g{{i}}_p{{p}}_fastest_pit"> Fastest pit (+2)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_last_rows_points" id="g{{i}}_p{{p}}_last_rows_points"> Parte ultime due file e va a punti (+2)</label>

      <label>Posizioni guadagnate (calcolate automaticamente):
        <input type="number" min="0" value="0" readonly id="g{{i}}_p{{p}}_pos_gain_display">
        <input type="hidden" name="g{{i}}_p{{p}}_pos_gain" id="g{{i}}_p{{p}}_pos_gain">
      </label>

      <!-- Vittoria / Podio (auto-selezione dallo script) -->
      <label><input type="checkbox" name="g{{i}}_p{{p}}_win" id="g{{i}}_p{{p}}_win"> Vittoria GP (+3)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_podium" id="g{{i}}_p{{p}}_podium"> Podio GP (+2)</label>

      <!-- MALUS -->
      <label><input type="checkbox" name="g{{i}}_p{{p}}_dsq" id="g{{i}}_p{{p}}_dsq"> Squalifica (-5)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_dnf" id="g{{i}}_p{{p}}_dnf"> DNF (-3)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_pen_6" id="g{{i}}_p{{p}}_pen_6"> Penalità ≥6s (-4)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_pen_5" id="g{{i}}_p{{p}}_pen_5"> Penalità ≤5s (-3)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_last_place" id="g{{i}}_p{{p}}_last_place"> Ultimo in gara (-2)</label>
      <label><input type="checkbox" name="g{{i}}_p{{p}}_no_q1" id="g{{i}}_p{{p}}_no_q1"> Non supera Q1 (-1)</label>

      <!-- campo nascosto pos_loss -->
      <input type="hidden" name="g{{i}}_p{{p}}_pos_loss" id="g{{i}}_p{{p}}_pos_loss" value="0">

      <hr>
      {% endfor %}
    </fieldset>
    {% endfor %}

    <button type="submit">Calcola risultati</button>
  </form>

  <script>
    // auto: win/podium e pos_gain/pos_loss
    function setupAuto() {
      for (let g = 1; g <= 6; g++) {
        for (let p = 1; p <= 2; p++) {
          const posEl = document.getElementById(`g${g}_p${p}_pos`);
          const grEl  = document.getElementById(`g${g}_p${p}_griglia`);
          const sprintEl = document.getElementById(`g${g}_p${p}_sprint`);
          const winEl = document.getElementById(`g${g}_p${p}_win`);
          const podiumEl = document.getElementById(`g${g}_p${p}_podium`);
          const gainDisplay = document.getElementById(`g${g}_p${p}_pos_gain_display`);
          const gainHidden = document.getElementById(`g${g}_p${p}_pos_gain`);
          const lossHidden = document.getElementById(`g${g}_p${p}_pos_loss`);

          function updateAll() {
            const pos = parseInt(posEl.value);
            const gr  = parseInt(grEl.value);
            const isSprint = sprintEl && sprintEl.checked;

            // auto posizione guadagnata/perdita
            if (!isNaN(pos) && !isNaN(gr)) {
              if (pos < gr) {
                const gain = gr - pos;
                gainDisplay.value = gain;
                gainHidden.value = gain;
                lossHidden.value = 0;
              } else if (pos > gr) {
                const loss = pos - gr;
                gainDisplay.value = 0;
                gainHidden.value = 0;
                lossHidden.value = loss;
              } else {
                gainDisplay.value = 0;
                gainHidden.value = 0;
                lossHidden.value = 0;
              }
            } else {
              gainDisplay.value = 0;
              gainHidden.value = 0;
              lossHidden.value = 0;
            }

            // auto win/podium solo se non sprint
            if (isSprint) {
              // non auto-selezionare
              return;
            }
            if (!isNaN(pos)) {
              if (pos === 1) {
                winEl.checked = true;
                podiumEl.checked = false;
              } else if (pos === 2 || pos === 3) {
                podiumEl.checked = true;
                winEl.checked = false;
              } else {
                winEl.checked = false;
                podiumEl.checked = false;
              }
            } else {
              winEl.checked = false;
              podiumEl.checked = false;
            }
          }

          posEl && posEl.addEventListener('input', updateAll);
          grEl && grEl.addEventListener('input', updateAll);
          sprintEl && sprintEl.addEventListener('change', updateAll);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', setupAuto);
  </script>
</body>
</html>
